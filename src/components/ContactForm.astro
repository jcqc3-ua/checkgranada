---
// Componente de formulario de contacto con Firebase
---

<section id="contacto" class="section contact-section">
  <div class="container">
    <div class="section-header">
      <h2>Reserva Tu Visita</h2>
      <p>Ponte en contacto para planificar tu experiencia personalizada</p>
    </div>
    
    <form id="contactForm" class="contact-form">
      <div class="form-row">
        <div class="form-group">
          <label for="nombre">Nombre Completo *</label>
          <input 
            type="text" 
            id="nombre" 
            name="nombre" 
            placeholder="Tu nombre" 
            required 
          />
        </div>
        <div class="form-group">
          <label for="email">Email *</label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            placeholder="tu@email.com" 
            required 
          />
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="telefono">Teléfono *</label>
          <input 
            type="tel" 
            id="telefono" 
            name="telefono" 
            placeholder="+34 600 000 000" 
            required 
          />
        </div>
        <div class="form-group">
          <label for="personas">Número de Personas *</label>
          <select id="personas" name="personas" required>
            <option value="">Selecciona...</option>
            <option value="1">1 persona</option>
            <option value="2">2 personas</option>
            <option value="3">3 personas</option>
            <option value="4">4 personas</option>
            <option value="5">5 personas</option>
            <option value="6">6 personas</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="visita">Tipo de Visita *</label>
        <select id="visita" name="visita" required>
          <option value="">Selecciona una visita...</option>
          <option value="alhambra-completa">Alhambra Completa - 450€</option>
          <option value="palacios-premium">Palacios Nazaríes Premium - 350€</option>
          <option value="jardines-alcazaba">Jardines y Alcazaba - 280€</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="fecha">Fecha Preferida</label>
        <input 
          type="date" 
          id="fecha" 
          name="fecha"
        />
      </div>
      
      <div class="form-group">
        <label for="mensaje">Mensaje (Preferencias, Horarios, etc.)</label>
        <textarea 
          id="mensaje" 
          name="mensaje" 
          rows="5" 
          placeholder="Cuéntanos tus preferencias..."
        ></textarea>
      </div>
      
      <div id="mensajeExito" class="mensaje-exito" style="display: none;">
        ✅ ¡Reserva enviada exitosamente! Nos pondremos en contacto pronto.
      </div>
      
      <div id="mensajeError" class="mensaje-error" style="display: none;">
        ❌ Error al enviar la reserva. Por favor, intenta de nuevo.
      </div>
      
      <button type="submit" class="btn btn-primary btn-large btn-submit" id="submitBtn">
        Enviar Solicitud de Reserva
      </button>
    </form>
  </div>
</section>

<script type="module">
  // Importar dinámicamente para evitar problemas de módulo
  import('/lib/reservasService.js').then(module => {
    const crearReserva = module.crearReserva;
    
    const form = document.getElementById('contactForm');
    if (!form) return;
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const mensajeExito = document.getElementById('mensajeExito');
      const mensajeError = document.getElementById('mensajeError');
      
      // Limpiar mensajes
      mensajeExito.style.display = 'none';
      mensajeError.style.display = 'none';
      
      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';
        
        const formData = {
          nombre: document.getElementById('nombre').value,
          email: document.getElementById('email').value,
          telefono: document.getElementById('telefono').value,
          personas: parseInt(document.getElementById('personas').value),
          visita: document.getElementById('visita').value,
          fecha: document.getElementById('fecha').value || null,
          mensaje: document.getElementById('mensaje').value
        };
        
        console.log('Datos del formulario:', formData);
        const resultado = await crearReserva(formData);
        console.log('Resultado:', resultado);
        
        if (resultado.exito) {
          mensajeExito.style.display = 'block';
          form.reset();
          
          setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Enviar Solicitud de Reserva';
            mensajeExito.style.display = 'none';
          }, 5000);
        } else {
          throw new Error(resultado.error || 'Error desconocido');
        }
        
      } catch (error) {
        console.error('Error completo:', error);
        mensajeError.textContent = '❌ Error: ' + (error.message || 'No se pudo enviar la reserva');
        mensajeError.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enviar Solicitud de Reserva';
      }
    });
  }).catch(err => {
    console.error('Error al cargar reservasService:', err);
  });
</script>

<style>
  .contact-section {
    background: linear-gradient(135deg, var(--bg-light) 0%, var(--white) 100%);
  }

  .contact-form {
    max-width: 700px;
    margin: 3rem auto;
    background: var(--white);
    padding: 3rem;
    border-radius: 15px;
    box-shadow: var(--shadow);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.7rem;
    font-weight: 600;
    color: var(--text-dark);
    font-size: 0.95rem;
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 0.9rem 1.1rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-family: 'Poppins', sans-serif;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: var(--bg-light);
  }

  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--primary);
    background: var(--white);
    box-shadow: 0 0 0 3px rgba(168, 50, 50, 0.1);
  }

  .form-group input::placeholder,
  .form-group textarea::placeholder {
    color: #999;
  }

  .btn-submit {
    width: 100%;
    margin-top: 1rem;
  }

  .mensaje-exito,
  .mensaje-error {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    text-align: center;
    font-weight: 600;
  }

  .mensaje-exito {
    background: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #c8e6c9;
  }

  .mensaje-error {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ffcdd2;
  }

  @media (max-width: 768px) {
    .form-row {
      grid-template-columns: 1fr;
    }

    .contact-form {
      padding: 2rem;
    }
  }
</style>
